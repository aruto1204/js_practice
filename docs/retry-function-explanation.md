# リトライ機能の動作フロー解説

## 全体構造図

```
┌─────────────────────────────────────────────────────────────┐
│                    retry(fn, maxAttempts, delay)             │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  let lastError;                                       │  │
│  │  for (attempt = 1; attempt <= maxAttempts; attempt++)│  │
│  └──────────────────────────────────────────────────────┘  │
│                          │                                   │
│                          ▼                                   │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  try {                                                │  │
│  │    console.log(`試行 ${attempt}/${maxAttempts}`)     │  │
│  │    const result = await fn();  ← unstableOperation() │  │
│  │    console.log('成功しました')                        │  │
│  │    return result;  ← 成功したらここで終了            │  │
│  │  }                                                    │  │
│  └──────────────────────────────────────────────────────┘  │
│                          │                                   │
│                    ┌─────┴─────┐                             │
│                    │           │                             │
│              成功  │           │  失敗                        │
│                    │           │                             │
│                    ▼           ▼                             │
│            ┌──────────┐  ┌──────────┐                      │
│            │ return    │  │ catch    │                      │
│            │ result    │  │ (error)  │                      │
│            └──────────┘  └──────────┘                      │
│                              │                               │
│                              ▼                               │
│                    ┌──────────────────┐                      │
│                    │ lastError = error│                      │
│                    └──────────────────┘                      │
│                              │                               │
│                    ┌─────────┴─────────┐                    │
│                    │                   │                    │
│            attempt < maxAttempts?       │                    │
│                    │                   │                    │
│              YES   │                   │   NO                │
│                    │                   │                    │
│                    ▼                   ▼                    │
│          ┌─────────────────┐   ┌──────────────┐              │
│          │ await delay     │   │ ループ継続   │              │
│          │ (500ms待機)     │   │ (次の試行へ)│              │
│          └─────────────────┘   └──────────────┘              │
│                    │                   │                    │
│                    └─────────┬─────────┘                    │
│                              │                               │
│                              ▼                               │
│                    ┌──────────────────┐                      │
│                    │  ループ終了後    │                      │
│                    │  throw lastError │                      │
│                    └──────────────────┘                      │
└─────────────────────────────────────────────────────────────┘
```

## 詳細フロー図

### 1. 初期化フェーズ

```
retry(unstableOperation, 5, 500) が呼ばれる
         │
         ├─ maxAttempts = 5 (最大5回試行)
         ├─ delay = 500 (500ミリ秒待機)
         └─ fn = unstableOperation (実行する関数)
         │
         ▼
┌────────────────────┐
│ let lastError;      │ ← 最後のエラーを保存する変数
│ attempt = 1         │ ← 試行回数のカウンター
└────────────────────┘
```

### 2. ループ処理の詳細

```
┌─────────────────────────────────────────────────────────┐
│  ループ: attempt = 1 から maxAttempts(5) まで            │
└─────────────────────────────────────────────────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │ 試行 ${attempt}/5 を表示 │
        └───────────────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │ await fn() を実行      │
        │ (unstableOperation())  │
        └───────────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
    成功 │                       │ 失敗
        │                       │
        ▼                       ▼
┌───────────────┐      ┌──────────────────┐
│ result を返す │      │ catch (error)     │
│ 処理終了      │      │ lastError = error │
└───────────────┘      └──────────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │ attempt < maxAttempts?│
                    └───────────────────────┘
                                │
                    ┌───────────┴───────────┐
                    │                       │
                YES │                       │ NO
                    │                       │
                    ▼                       ▼
        ┌───────────────────┐   ┌──────────────────┐
        │ await delay(500ms)│   │ ループ継続        │
        │ 待機してリトライ   │   │ (次の試行へ)      │
        └───────────────────┘   └──────────────────┘
                    │                       │
                    └───────────┬──────────┘
                                │
                                ▼
                        ループの先頭に戻る
```

### 3. unstableOperation関数の動作

```
┌─────────────────────────────────────────────┐
│  function unstableOperation()               │
│                                             │
│  attemptCount++  ← 試行回数をカウント      │
│                                             │
│  return new Promise((resolve, reject) => {  │
│    if (Math.random() > 0.3) {              │
│      ┌──────────────────────────┐          │
│      │ 70%の確率でここに入る    │          │
│      │ reject(エラー)           │          │
│      └──────────────────────────┘          │
│    } else {                                 │
│      ┌──────────────────────────┐          │
│      │ 30%の確率でここに入る    │          │
│      │ resolve(成功)            │          │
│      └──────────────────────────┘          │
│    }                                        │
│  });                                        │
└─────────────────────────────────────────────┘
```

### 4. 実行シナリオ例

#### シナリオ1: 2回目で成功する場合

```
試行 1/5
  ↓
unstableOperation() 実行
  ↓
失敗（試行1回目） ← 70%の確率
  ↓
lastError = エラーを保存
  ↓
attempt(1) < maxAttempts(5) → YES
  ↓
500ms 待機
  ↓
─────────────────────────────
試行 2/5
  ↓
unstableOperation() 実行
  ↓
成功（試行2回目） ← 30%の確率
  ↓
return result ← ここで処理終了
  ↓
.then() で「最終結果: 成功（試行2回目）」を表示
```

#### シナリオ2: すべて失敗する場合

```
試行 1/5 → 失敗 → 500ms待機
試行 2/5 → 失敗 → 500ms待機
試行 3/5 → 失敗 → 500ms待機
試行 4/5 → 失敗 → 500ms待機
試行 5/5 → 失敗
  ↓
attempt(5) < maxAttempts(5) → NO
  ↓
ループ終了
  ↓
throw lastError ← 最後のエラーを投げる
  ↓
.catch() で「すべて失敗: 失敗（試行5回目）」を表示
```

## コードの重要なポイント

### 1. エラーの保存
```javascript
let lastError;  // 最後のエラーを保存
```
- すべての試行が失敗した場合、最後のエラーを投げるために必要

### 2. 待機処理
```javascript
await new Promise((resolve) => setTimeout(resolve, delay));
```
- `setTimeout`を使って非同期で待機
- `Promise`でラップして`await`で待つ

### 3. 早期リターン
```javascript
if (成功) {
  return result;  // 成功したら即座に終了
}
```
- 成功したら残りの試行をスキップして結果を返す

### 4. 最後のエラーを投げる
```javascript
throw lastError;  // ループ終了後、すべて失敗した場合
```
- すべての試行が失敗した場合のみ実行される

## タイムライン図

```
時間軸 →

retry()開始
  │
  ├─ 試行1実行 ──→ 失敗 ──→ 500ms待機 ──┐
  │                                      │
  │                                      ▼
  │                             試行2実行 ──→ 成功 ──→ 終了
  │
  └─ (すべて失敗する場合)
     試行1 → 失敗 → 500ms待機
     試行2 → 失敗 → 500ms待機
     試行3 → 失敗 → 500ms待機
     試行4 → 失敗 → 500ms待機
     試行5 → 失敗 → throw lastError
```

## まとめ

このリトライ機能は以下の特徴があります：

1. **最大試行回数**: `maxAttempts`回まで試行
2. **待機時間**: 各試行の間に`delay`ミリ秒待機
3. **早期終了**: 成功したら即座に結果を返す
4. **エラー保存**: 最後のエラーを保存し、すべて失敗した場合に投げる
5. **非同期対応**: `async/await`で非同期処理を扱う
